<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RAGDOLL STICKMAN ×24 – 20 Pure Ragdolls per Generation</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;600&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0f; color: #c8f0ff; font-family: 'Share Tech Mono', monospace; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
  #header { padding: 5px 16px; border-bottom: 1px solid #1a3a4a; display: flex; align-items: center; gap: 24px; background: #0d0d18; flex-shrink: 0; }
  #header h1 { font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 0.95rem; letter-spacing: 4px; color: #00e5ff; text-shadow: 0 0 20px #00e5ff88; }
  .stat { display: flex; flex-direction: column; gap: 1px; }
  .stat-label { font-size: 0.5rem; color: #456; letter-spacing: 2px; text-transform: uppercase; }
  .stat-value { font-size: 0.85rem; color: #00e5ff; }
  #grid { flex: 1; display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(4, 1fr); gap: 2px; background: #111; }
  .sim-wrap { position: relative; overflow: hidden; }
  .sim-wrap canvas { display: block; width: 100%; height: 100%; }
  .sim-label { position: absolute; top: 3px; left: 4px; font-size: 0.42rem; letter-spacing: 1px; opacity: 0.7; pointer-events: none; }
  .sim-stats { position: absolute; top: 3px; right: 4px; font-size: 0.42rem; text-align: right; opacity: 0.8; pointer-events: none; line-height: 1.4; }
  #controls { position: fixed; bottom: 12px; right: 14px; display: flex; gap: 8px; z-index: 10; align-items: center; }
  button { background: #0d1a25; border: 1px solid #00e5ff44; color: #00e5ff; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; padding: 5px 12px; cursor: pointer; letter-spacing: 1px; }
  button:hover { background: #00e5ff22; border-color: #00e5ff; }
  #hint { position: fixed; bottom: 14px; left: 14px; font-size: 0.6rem; color: #345; letter-spacing: 2px; z-index: 10; }
</style>
</head>
<body>
<div id="header">
  <h1>RAGDOLL STICKMAN ×24 – 20 Pure Ragdolls per Generation</h1>
  <div class="stat"><span class="stat-label">Speed</span><span class="stat-value" id="spd">1x</span></div>
</div>
<div id="grid"></div>
<div id="hint">[ R ] reset all</div>
<div id="controls">
  <label style="color:#00e5ff;font-size:0.7rem;letter-spacing:1px;">SPEED
    <input type="range" id="speedSlider" min="1" max="16" value="1" step="1"
      style="width:100px;margin:0 8px;accent-color:#00e5ff;vertical-align:middle;"
      oninput="updateSpeed(this.value)">
    <span id="spd2" style="min-width:30px;display:inline-block;">1x</span>
  </label>
  <button onclick="resetAll()">↻ RESET</button>
</div>

<script>
var NUM_SIMS   = 24;
var POP_SIZE   = 20;
var STEP_LIMIT = 1100;

var THIGH     = 22;
var SHIN      = 20;
var FOOT      = 12;
var TORSO     = 30;
var HEAD_R    = 7;
var UPPER_ARM = 14;
var FOREARM   = 12;
var HAND      = 8;

var GRAVITY       = 0.38;
var FORCE_SCALE   = 0.16;
var DAMPING_AIR   = 0.995;
var DAMPING_GND   = 0.935;
var MAX_JOINT_VEL = 0.18;   // slightly higher for more energetic movement

var HIP_MIN   = -1.57;   var HIP_MAX   = 2.35;   // ← MUCH wider (hip can swing way back & high forward)
var KNEE_MIN  =  0.0;    var KNEE_MAX  = 2.95;   // ← full knee bend (almost 170°)
var ANKLE_MIN = -0.7;    var ANKLE_MAX = 0.9;    // ← also widened a bit for better foot plant

var ELBOW_MIN = -1.8;   var ELBOW_MAX = 0.4;
var WRIST_MIN = -0.8;   var WRIST_MAX = 0.8;
var SHOULDER_MIN = -2.8; var SHOULDER_MAX = 2.8;

var GRAV_TORQUE_HIP      = 0.011;
var GRAV_TORQUE_KNEE     = 0.016;
var GRAV_TORQUE_ANKLE    = 0.0;
var GRAV_TORQUE_SHOULDER = 0.009;
var GRAV_TORQUE_ELBOW    = 0.013;
var GRAV_TORQUE_WRIST    = 0.005;
var GRAV_TORQUE_TORSO    = 0.004;

var ANKLE_OFFSET = -Math.PI / 2;

var SIM_COLORS = [
  '#00e5ff','#ff9900','#cc44ff','#00ff88','#ff4488','#ffee00',
  '#00ccff','#ff6600','#88ff00','#ff00cc','#00ffcc','#ff3300',
  '#44aaff','#ffaa00','#aa44ff','#00ffaa','#ff44aa','#aaff00',
  '#00aaff','#ff6644','#66ff88','#ff0088','#00ffee','#ff4400'
];
var SIM_NAMES = 'ABCDEFGHIJKLMNOPQRSTUVWX'.split('');

var grid = document.getElementById('grid');
var fragment = document.createDocumentFragment();
for (var i = 0; i < NUM_SIMS; i++) {
  var wrap = document.createElement('div');
  wrap.className = 'sim-wrap';
  wrap.id = 'wrap'+i;
  wrap.innerHTML =
    '<canvas id="c'+i+'"></canvas>' +
    '<div class="sim-label" style="color:'+SIM_COLORS[i]+'">■ SIM '+SIM_NAMES[i]+'</div>' +
    '<div class="sim-stats" id="stats'+i+'"></div>';
  fragment.appendChild(wrap);
}
grid.appendChild(fragment);

function Stickman(sim) {
  this.sim = sim;
  this.prevHvx = 0;
  this.reset();
}

Stickman.prototype.reset = function() {
  var s = this.sim;
  var GY = s.GY;
  this.alive   = true;
  this.fitness = 0;
  this.maxX    = s.STARTX;
  this.prevHvx = 0;

  this.hx  = s.STARTX + (Math.random()-0.5)*12;
  this.hy  = GY - SHIN - THIGH - FOOT/2 - 8;
  this.hvx = (Math.random()-0.5)*1.8;
  this.hvy = (Math.random()-0.5)*1.2;

  this.lHip   = (Math.random()-0.5)*1.8;   this.lHipV   = (Math.random()-0.5)*0.7;
  this.lKne   = 0.2 + (Math.random()-0.5)*2.0; this.lKneV   = (Math.random()-0.5)*0.7;
  this.lAnkle = (Math.random()-0.5)*1.2;   this.lAnkleV = (Math.random()-0.5)*0.5;

  this.rHip   = (Math.random()-0.5)*1.8;   this.rHipV   = (Math.random()-0.5)*0.7;
  this.rKne   = 0.2 + (Math.random()-0.5)*2.0; this.rKneV   = (Math.random()-0.5)*0.7;
  this.rAnkle = (Math.random()-0.5)*1.2;   this.rAnkleV = (Math.random()-0.5)*0.5;

  this.lShould = (Math.random()-0.5)*3.0;  this.lShouldV = (Math.random()-0.5)*0.6;
  this.lElb    = (Math.random()-0.5)*2.6;  this.lElbV    = (Math.random()-0.5)*0.6;
  this.lWrist  = (Math.random()-0.5)*2.0;  this.lWristV  = (Math.random()-0.5)*0.45;

  this.rShould = (Math.random()-0.5)*3.0;  this.rShouldV = (Math.random()-0.5)*0.6;
  this.rElb    = (Math.random()-0.5)*2.6;  this.rElbV    = (Math.random()-0.5)*0.6;
  this.rWrist  = (Math.random()-0.5)*2.0;  this.rWristV  = (Math.random()-0.5)*0.45;

  this.torsoLean  = (Math.random()-0.5)*0.9;
  this.torsoLeanV = (Math.random()-0.5)*0.35;

  for (let settle = 0; settle < 60; settle++) {   // extra settling for new ranges
    this.hy += 0.25;
    let p = this.fk();
    if (p.lFoot.y > GY) this.hy -= (p.lFoot.y - GY) * 0.75;
    if (p.rFoot.y > GY) this.hy -= (p.rFoot.y - GY) * 0.75;
    this.hvx *= 0.82; this.hvy *= 0.82;
    this.lHipV *= 0.78; this.lKneV *= 0.78; this.lAnkleV *= 0.78;
    this.rHipV *= 0.78; this.rKneV *= 0.78; this.rAnkleV *= 0.78;
    this.lShouldV *= 0.78; this.lElbV *= 0.78; this.lWristV *= 0.78;
    this.rShouldV *= 0.78; this.rElbV *= 0.78; this.rWristV *= 0.78;
    this.torsoLeanV *= 0.78;
  }
  this.hvx = this.hvy = 0;
};

Stickman.prototype.fk = function() {
  var hx = this.hx, hy = this.hy;
  var tiltX = Math.sin(this.torsoLean) * 10;
  var tiltY = Math.cos(this.torsoLean) * 5 - 5;
  var sx = hx + tiltX;
  var sy = hy - TORSO + tiltY;

  var hd = { x: sx, y: sy - HEAD_R * 2.2 };

  var lkx = hx - Math.sin(this.lHip) * THIGH;
  var lky = hy + Math.cos(this.lHip) * THIGH;
  var lSA = this.lHip + this.lKne;
  var lax = lkx - Math.sin(lSA) * SHIN;
  var lay = lky + Math.cos(lSA) * SHIN;
  var lFA = lSA + this.lAnkle + ANKLE_OFFSET;
  var lfx = lax - Math.sin(lFA) * FOOT;
  var lfy = lay + Math.cos(lFA) * FOOT;

  var rkx = hx - Math.sin(this.rHip) * THIGH;
  var rky = hy + Math.cos(this.rHip) * THIGH;
  var rSA = this.rHip + this.rKne;
  var rax = rkx - Math.sin(rSA) * SHIN;
  var ray = rky + Math.cos(rSA) * SHIN;
  var rFA = rSA + this.rAnkle + ANKLE_OFFSET;
  var rfx = rax - Math.sin(rFA) * FOOT;
  var rfy = ray + Math.cos(rFA) * FOOT;

  var lSAng = this.lShould;
  var lEx = sx - Math.sin(lSAng) * UPPER_ARM;
  var lEy = sy + Math.cos(lSAng) * UPPER_ARM;
  var lElbAng = lSAng + this.lElb;
  var lWx = lEx - Math.sin(lElbAng) * FOREARM;
  var lWy = lEy + Math.cos(lElbAng) * FOREARM;
  var lWristAng = lElbAng + this.lWrist;
  var lHx = lWx - Math.sin(lWristAng) * HAND;
  var lHy = lWy + Math.cos(lWristAng) * HAND;

  var rSAng = this.rShould;
  var rEx = sx - Math.sin(rSAng) * UPPER_ARM;
  var rEy = sy + Math.cos(rSAng) * UPPER_ARM;
  var rElbAng = rSAng + this.rElb;
  var rWx = rEx - Math.sin(rElbAng) * FOREARM;
  var rWy = rEy + Math.cos(rElbAng) * FOREARM;
  var rWristAng = rElbAng + this.rWrist;
  var rHx = rWx - Math.sin(rWristAng) * HAND;
  var rHy = rWy + Math.cos(rWristAng) * HAND;

  return {
    hip:      { x:hx, y:hy },
    shoulder: { x:sx, y:sy },
    head:     hd,
    lKnee:    { x:lkx, y:lky },
    lAnkle:   { x:lax, y:lay },
    lFoot:    { x:lfx, y:lfy },
    rKnee:    { x:rkx, y:rky },
    rAnkle:   { x:rax, y:ray },
    rFoot:    { x:rfx, y:rfy },
    lElbow:   { x:lEx, y:lEy },
    lWrist:   { x:lWx, y:lWy },
    lHand:    { x:lHx, y:lHy },
    rElbow:   { x:rEx, y:rEy },
    rWrist:   { x:rWx, y:rWy },
    rHand:    { x:rHx, y:rHy }
  };
};

Stickman.prototype.step = function() {
  if (!this.alive) return;

  var GY = this.sim.GY;

  this.lHipV   += -GRAV_TORQUE_HIP   * Math.sin(this.lHip);
  this.lKneV   += -GRAV_TORQUE_KNEE  * Math.sin(this.lHip + this.lKne);
  this.lAnkleV += -GRAV_TORQUE_ANKLE * Math.sin(this.lHip + this.lKne + this.lAnkle + ANKLE_OFFSET);

  this.rHipV   += -GRAV_TORQUE_HIP   * Math.sin(this.rHip);
  this.rKneV   += -GRAV_TORQUE_KNEE  * Math.sin(this.rHip + this.rKne);
  this.rAnkleV += -GRAV_TORQUE_ANKLE * Math.sin(this.rHip + this.rKne + this.rAnkle + ANKLE_OFFSET);

  this.lShouldV += -GRAV_TORQUE_SHOULDER * Math.sin(this.lShould);
  this.lElbV    += -GRAV_TORQUE_ELBOW    * Math.sin(this.lShould + this.lElb);
  this.lWristV  += -GRAV_TORQUE_WRIST    * Math.sin(this.lShould + this.lElb + this.lWrist);

  this.rShouldV += -GRAV_TORQUE_SHOULDER * Math.sin(this.rShould);
  this.rElbV    += -GRAV_TORQUE_ELBOW    * Math.sin(this.rShould + this.rElb);
  this.rWristV  += -GRAV_TORQUE_WRIST    * Math.sin(this.rShould + this.rElb + this.rWrist);

  this.torsoLeanV += -GRAV_TORQUE_TORSO * Math.sin(this.torsoLean);

  this.lHipV *= DAMPING_AIR; this.lKneV *= DAMPING_AIR; this.lAnkleV *= DAMPING_AIR;
  this.rHipV *= DAMPING_AIR; this.rKneV *= DAMPING_AIR; this.rAnkleV *= DAMPING_AIR;
  this.lShouldV *= DAMPING_AIR; this.lElbV *= DAMPING_AIR; this.lWristV *= DAMPING_AIR;
  this.rShouldV *= DAMPING_AIR; this.rElbV *= DAMPING_AIR; this.rWristV *= DAMPING_AIR;
  this.torsoLeanV *= DAMPING_AIR;

  this.lHipV   = Math.max(-MAX_JOINT_VEL, Math.min(MAX_JOINT_VEL, this.lHipV));
  this.lKneV   = Math.max(-MAX_JOINT_VEL*1.1, Math.min(MAX_JOINT_VEL*1.1, this.lKneV));   // knees move faster
  this.lAnkleV = Math.max(-MAX_JOINT_VEL*0.7, Math.min(MAX_JOINT_VEL*0.7, this.lAnkleV));
  this.rHipV   = Math.max(-MAX_JOINT_VEL, Math.min(MAX_JOINT_VEL, this.rHipV));
  this.rKneV   = Math.max(-MAX_JOINT_VEL*1.1, Math.min(MAX_JOINT_VEL*1.1, this.rKneV));
  this.rAnkleV = Math.max(-MAX_JOINT_VEL*0.7, Math.min(MAX_JOINT_VEL*0.7, this.rAnkleV));
  this.lShouldV = Math.max(-MAX_JOINT_VEL, Math.min(MAX_JOINT_VEL, this.lShouldV));
  this.lElbV    = Math.max(-MAX_JOINT_VEL*0.8, Math.min(MAX_JOINT_VEL*0.8, this.lElbV));
  this.lWristV  = Math.max(-MAX_JOINT_VEL*0.6, Math.min(MAX_JOINT_VEL*0.6, this.lWristV));
  this.rShouldV = Math.max(-MAX_JOINT_VEL, Math.min(MAX_JOINT_VEL, this.rShouldV));
  this.rElbV    = Math.max(-MAX_JOINT_VEL*0.8, Math.min(MAX_JOINT_VEL*0.8, this.rElbV));
  this.rWristV  = Math.max(-MAX_JOINT_VEL*0.6, Math.min(MAX_JOINT_VEL*0.6, this.rWristV));

  this.lHip   += this.lHipV;   this.lKne   += this.lKneV;   this.lAnkle += this.lAnkleV;
  this.rHip   += this.rHipV;   this.rKne   += this.rKneV;   this.rAnkle += this.rAnkleV;
  this.lShould += this.lShouldV; this.lElb += this.lElbV; this.lWrist += this.lWristV;
  this.rShould += this.rShouldV; this.rElb += this.rElbV; this.rWrist += this.rWristV;
  this.torsoLean += this.torsoLeanV;

  this.lHip   = Math.max(HIP_MIN,   Math.min(HIP_MAX,   this.lHip));
  this.rHip   = Math.max(HIP_MIN,   Math.min(HIP_MAX,   this.rHip));
  this.lKne   = Math.max(KNEE_MIN,  Math.min(KNEE_MAX,  this.lKne));
  this.rKne   = Math.max(KNEE_MIN,  Math.min(KNEE_MAX,  this.rKne));
  this.lAnkle = Math.max(ANKLE_MIN, Math.min(ANKLE_MAX, this.lAnkle));
  this.rAnkle = Math.max(ANKLE_MIN, Math.min(ANKLE_MAX, this.rAnkle));
  this.lElb   = Math.max(ELBOW_MIN, Math.min(ELBOW_MAX, this.lElb));
  this.rElb   = Math.max(ELBOW_MIN, Math.min(ELBOW_MAX, this.rElb));
  this.lWrist = Math.max(WRIST_MIN, Math.min(WRIST_MAX, this.lWrist));
  this.rWrist = Math.max(WRIST_MIN, Math.min(WRIST_MAX, this.rWrist));
  this.lShould = Math.max(SHOULDER_MIN, Math.min(SHOULDER_MAX, this.lShould));
  this.rShould = Math.max(SHOULDER_MIN, Math.min(SHOULDER_MAX, this.rShould));
  this.torsoLean = Math.max(-1.0, Math.min(1.0, this.torsoLean));

  var p2 = this.fk();
  var fx = 0, fy = 0;
  var applyFootContact = (footY, hipA, kneeA, ankleA) => {
    if (footY > GY) {
      var pen = footY - GY;
      var footAngle = hipA + kneeA + ankleA + ANKLE_OFFSET;
      fy -= pen * 1.8;
      fx -= Math.sin(footAngle) * pen * 1.0;
    }
  };
  applyFootContact(p2.lFoot.y, this.lHip, this.lKne, this.lAnkle);
  applyFootContact(p2.rFoot.y, this.rHip, this.rKne, this.rAnkle);

  this.hvy += GRAVITY * FORCE_SCALE;
  this.hvy += fy * 0.9 * FORCE_SCALE;
  this.hvx += fx * FORCE_SCALE;

  var anyFootContact = p2.lFoot.y >= GY - 2 || p2.rFoot.y >= GY - 2;
  if (anyFootContact) {
    this.hvx *= DAMPING_GND;
    this.hvy *= 0.65;
  } else {
    this.hvx *= DAMPING_AIR;
  }

  this.hx += this.hvx;
  this.hy += this.hvy;

  var hipFloor = GY - THIGH - SHIN - FOOT/2 + 2;
  if (this.hy > hipFloor) { this.hy = hipFloor; if (this.hvy > 0) this.hvy = 0; }
  if (this.hy < 15) { this.hy = 15; this.hvy = 0; }

  if (this.hx > this.maxX) this.maxX = this.hx;

  let progress      = Math.max(0, this.maxX - this.sim.STARTX) ** 1.3;
  let uprightBonus  = Math.max(0, (GY - p2.head.y - 10) / 80) ** 1.6 * 110;
  let velBonus      = Math.max(0, this.hvx) * 22;
  let smoothPenalty = Math.abs(this.hvx - this.prevHvx) * 8;
  this.prevHvx = this.hvx;

  this.fitness = progress * 1.8 + uprightBonus + velBonus * 0.7 - smoothPenalty * 1.4;

  var p3 = this.fk();
  if (p3.head.y + HEAD_R > GY || p3.shoulder.y > GY - 6) {
    this.alive = false;
  }
};

Stickman.prototype.draw = function(ctx, isChamp, baseColor) {
  var p = this.fk();
  let drawColor  = isChamp ? baseColor : baseColor + '55';
  let drawColor2 = isChamp ? baseColor + '88' : baseColor + '28';
  let lineWidth  = isChamp ? 2.6 : 1.4;

  ctx.save();
  ctx.globalAlpha = isChamp ? 1.0 : 0.42;
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  if (isChamp) {
    ctx.shadowColor = baseColor;
    ctx.shadowBlur  = 14;
  }

  function seg(a, b, c) {
    ctx.strokeStyle = c || drawColor;
    ctx.lineWidth = lineWidth;
    ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
  }

  seg(p.hip,      p.rKnee,  drawColor2);
  seg(p.rKnee,    p.rAnkle, drawColor2);
  seg(p.rAnkle,   p.rFoot,  drawColor2);
  seg(p.shoulder, p.rElbow, drawColor2);
  seg(p.rElbow,   p.rWrist, drawColor2);
  seg(p.rWrist,   p.rHand,  drawColor2);

  seg(p.hip,      p.shoulder);
  seg(p.hip,      p.lKnee);
  seg(p.lKnee,    p.lAnkle);
  seg(p.lAnkle,   p.lFoot);
  seg(p.shoulder, p.lElbow);
  seg(p.lElbow,   p.lWrist);
  seg(p.lWrist,   p.lHand);

  ctx.strokeStyle = drawColor;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  ctx.arc(p.head.x, p.head.y, HEAD_R, 0, Math.PI*2);
  ctx.stroke();

  if (isChamp) {
    ctx.fillStyle = baseColor;
    ctx.shadowBlur = 0;
    [p.hip, p.lKnee, p.rKnee, p.lAnkle, p.rAnkle, p.lElbow, p.rElbow].forEach(j => {
      ctx.beginPath(); ctx.arc(j.x, j.y, 2.2, 0, Math.PI*2); ctx.fill();
    });
  }
  ctx.restore();
};

function Simulation(idx) {
  this.idx       = idx;
  this.color     = SIM_COLORS[idx];
  this.canvas    = document.getElementById('c'+idx);
  this.ctx       = this.canvas.getContext('2d');
  this.W = this.H = this.GY = this.STARTX = this.camX = 0;
  this.generation = 0;
  this.simStep   = 0;
  this.bestEver  = 0;
  this.stickmen  = [];
  this.resize();
}

Simulation.prototype.resize = function() {
  var wrap = this.canvas.parentElement;
  this.W = this.canvas.width  = wrap.offsetWidth;
  this.H = this.canvas.height = wrap.offsetHeight;
  this.GY     = Math.floor(this.H * 0.78);
  this.STARTX = Math.floor(this.W * 0.5);
};

Simulation.prototype.spawnGeneration = function() {
  this.generation++;
  this.simStep = 0;
  this.stickmen = [];
  for (var i = 0; i < POP_SIZE; i++) {
    this.stickmen.push(new Stickman(this));
  }
};

Simulation.prototype.init = function() {
  this.generation = 0;
  this.bestEver = 0;
  this.camX = this.STARTX - this.W * 0.5;
  this.spawnGeneration();
};

Simulation.prototype.getChamp = function() {
  var best = this.stickmen[0];
  for (var i = 1; i < this.stickmen.length; i++) {
    if (this.stickmen[i].fitness > best.fitness) best = this.stickmen[i];
  }
  return best;
};

Simulation.prototype.update = function() {
  var alive = 0;
  for (var i = 0; i < this.stickmen.length; i++) {
    this.stickmen[i].step();
    if (this.stickmen[i].alive) alive++;
  }
  this.simStep++;

  if (this.simStep >= STEP_LIMIT || alive < POP_SIZE * 0.18) {
    this.spawnGeneration();
  }
};

Simulation.prototype.draw = function() {
  var ctx = this.ctx, W = this.W, H = this.H, GY = this.GY;
  ctx.clearRect(0, 0, W, H);

  var bg = ctx.createLinearGradient(0,0,0,H);
  bg.addColorStop(0,'#060610'); bg.addColorStop(1,'#08121e');
  ctx.fillStyle = bg; ctx.fillRect(0,0,W,H);

  var champ = this.getChamp();
  this.camX = champ.hx - W * 0.5;

  ctx.save();
  ctx.translate(-this.camX, 0);

  ctx.strokeStyle = '#0c1820'; ctx.lineWidth = 1;
  var gx0 = Math.floor(this.camX/50)*50;
  for (var gx = gx0; gx < this.camX + W + 50; gx += 50) {
    ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke();
  }
  for (var gy2 = 0; gy2 < H; gy2 += 50) {
    ctx.beginPath(); ctx.moveTo(this.camX,gy2); ctx.lineTo(this.camX+W,gy2); ctx.stroke();
  }

  var gr = ctx.createLinearGradient(0,GY,0,H);
  gr.addColorStop(0,'#0e2535'); gr.addColorStop(1,'#05101a');
  ctx.fillStyle = gr; ctx.fillRect(this.camX, GY, this.camX + W*4, H-GY);
  ctx.strokeStyle = this.color+'44'; ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(this.camX,GY); ctx.lineTo(this.camX+W*4,GY); ctx.stroke();

  ctx.strokeStyle = '#ffffff18'; ctx.lineWidth = 1;
  for (var mx = this.STARTX; mx < this.camX + W*4; mx += 100) {
    ctx.beginPath(); ctx.moveTo(mx,GY-6); ctx.lineTo(mx,GY); ctx.stroke();
  }

  for (var i = 0; i < this.stickmen.length; i++) {
    if (this.stickmen[i] !== champ)
      this.stickmen[i].draw(ctx, false, this.color);
  }
  champ.draw(ctx, true, this.color);

  ctx.restore();

  ctx.fillStyle = '#0d1a25'; ctx.fillRect(0, H-3, W, 3);
  var barW = Math.min(W, Math.max(0, champ.fitness / 580) * W);
  ctx.fillStyle = this.color+'aa'; ctx.fillRect(0, H-3, barW, 3);

  var aliveCnt = 0, bestFit = -999999;
  for (var i = 0; i < this.stickmen.length; i++) {
    if (this.stickmen[i].alive) aliveCnt++;
    if (this.stickmen[i].fitness > bestFit) bestFit = this.stickmen[i].fitness;
  }
  if (bestFit > this.bestEver) this.bestEver = bestFit;

  document.getElementById('stats'+this.idx).innerHTML =
    '<span style="color:'+this.color+'">GEN '+this.generation+'</span><br>' +
    'ALIVE '+aliveCnt+'/'+POP_SIZE+'<br>' +
    'BEST '+(bestFit >= 0 ? '+' : '')+Math.round(bestFit)+' px<br>' +
    'RECORD '+Math.round(this.bestEver)+' px';
};

var sims = [], frameCount = 0, simSpeed = 1, animId;

function updateSpeed(v) {
  simSpeed = parseInt(v);
  document.getElementById('spd').textContent  = simSpeed+'x';
  document.getElementById('spd2').textContent = simSpeed+'x';
}

function initAll() {
  sims = [];
  for (var i = 0; i < NUM_SIMS; i++) {
    var s = new Simulation(i);
    s.init();
    sims.push(s);
  }
}

function simLoop() {
  animId = requestAnimationFrame(simLoop);
  frameCount++;
  var stepsThisFrame = (simSpeed <= 1) ? (frameCount % 2 === 0 ? 1 : 0) : simSpeed;
  for (var t = 0; t < stepsThisFrame; t++) {
    for (var i = 0; i < sims.length; i++) sims[i].update();
  }
  for (var i = 0; i < sims.length; i++) sims[i].draw();
}

function resetAll() {
  cancelAnimationFrame(animId);
  document.getElementById('speedSlider').value = 1;
  updateSpeed(1);
  initAll(); simLoop();
}

window.addEventListener('resize', function() { for (var i=0;i<sims.length;i++) sims[i].resize(); });
window.addEventListener('keydown', function(e) { if (e.code==='KeyR') resetAll(); });
window.addEventListener('load', function() {
  initAll(); simLoop();
});
</script>
</body>
</html>
